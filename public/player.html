<!DOCTYPE html>
<html>
<head>
  <title>Player Screen</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display.swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="header">
    <h1 id="app-title">Player View</h1>
    <div id="game-title-container">
      <select id="mode-select">
        <option value="initiative">Initiative</option>
        <option value="background">Background</option>
      </select>
    </div>
  </div>

  <div id="initiative-mode-content" class="container">
    <h1>Initiative</h1>
    <div id="player-init-list-container" class="tab-content active" style="border-top: 1px solid var(--border-color); border-radius: var(--radius-sharp);">
      <ul id="player-init-list">
        <!-- Player initiative list items -->
      </ul>
      <p id="waiting-msg">Waiting for initiative...</p>
    </div>
  </div>

  <div id="background-mode-content" class="container" style="display: none;">
    <h1>Background</h1>
    <p>This is the background mode. Placeholder text.</p>
  </div>

  <script>
    let initiativeList = [];

    function setupModeSelection() {
      const modeSelect = document.getElementById("mode-select");
      const initiativeContent = document.getElementById("initiative-mode-content");
      const backgroundContent = document.getElementById("background-mode-content");

      if (!modeSelect || !initiativeContent || !backgroundContent) return;

      modeSelect.addEventListener("change", (e) => {
        const selectedMode = e.target.value;
        if (selectedMode === "initiative") {
          initiativeContent.style.display = "block";
          backgroundContent.style.display = "none";
        } else {
          initiativeContent.style.display = "none";
          backgroundContent.style.display = "block";
        }
      });
    }

    function setupWebSocket() {
      const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const ws = new WebSocket(`${wsProtocol}//${window.location.host}`);

      ws.onopen = () => console.log("Player WebSocket connected.");

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        const initView = document.getElementById("initiative-mode-content");

        if (data.type === "game-change") {
            // The logic to hide/show based on game type is now implicitly handled by the DM's screen
            // and the player's own mode selection. We just receive updates.
        }

        if (data.type === "initiative-update") {
          const isNewItem = data.payload.length > initiativeList.length;
          initiativeList = data.payload;
          renderInitiativeList(isNewItem);
        }
      };

      ws.onclose = () => {
        console.log("Player WebSocket disconnected. Reconnecting...");
        setTimeout(setupWebSocket, 3000);
      };
    }

    function renderInitiativeList(animateNew) {
      const listEl = document.getElementById("player-init-list");
      const waitingMsg = document.getElementById("waiting-msg");
      listEl.innerHTML = ""; 

      if (initiativeList.length === 0) {
        waitingMsg.style.display = "block";
      } else {
        waitingMsg.style.display = "none";
      }

      initiativeList.forEach((item, index) => {
        const li = document.createElement("li");
        const iconContainer = document.createElement("div");
        iconContainer.className = "player-icon-container";
        const icon = document.createElement("i");
        icon.className = item.iconClass;
        iconContainer.appendChild(icon);
        li.appendChild(iconContainer);
        const rollSpan = document.createElement("span");
        rollSpan.className = "init-roll";
        rollSpan.textContent = item.roll;
        li.appendChild(rollSpan);

        if (animateNew && index === initiativeList.length - 1) {
          li.classList.add("new-item-pop");
          setTimeout(() => li.classList.remove("new-item-pop"), 600);
          const sparkleContainer = document.createElement("div");
          sparkleContainer.className = "sparkle-container";
          for (let i = 0; i < 5; i++) {
            const spark = document.createElement("span");
            spark.className = "spark";
            spark.style.transform = `rotate(${i * 72}deg)`; 
            sparkleContainer.appendChild(spark);
          }
          iconContainer.appendChild(sparkleContainer);
          setTimeout(() => sparkleContainer.remove(), 1000);
        }
        listEl.appendChild(li);
      });
    }

    // Initialize
    setupModeSelection();
    setupWebSocket();
  </script>
</body>
</html>